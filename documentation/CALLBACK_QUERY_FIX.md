# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ "Query is too old and response timeout expired"

## üîç –ü—Ä–∏—á–∏–Ω—ã –æ—à–∏–±–∫–∏:

1. **Callback query –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –¥–æ–ª—å—à–µ 60 —Å–µ–∫—É–Ω–¥** - Telegram –æ—Ç–º–µ–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å
2. **–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ callback query  
3. **–°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏** –≤ –∫–æ–¥–µ –ø—Ä–∏–≤–æ–¥—è—Ç –∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ
4. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ `answer_callback_query()`** –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö callback queries

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–ø—Ä–∏–º–µ–Ω–µ–Ω—ã):

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:
**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–ª–æ–∫ –∫–æ–¥–∞ –¥–ª—è `set_topic_prompt` –±—ã–ª –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ `my_commands`
```python
# –ë–´–õ–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):
elif data == "my_commands":
    # –∫–æ–¥ my_commands
    # –∫–æ–¥ set_topic_prompt (–ë–ï–ó elif!)

# –°–¢–ê–õ–û (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):  
elif data == "my_commands":
    # –∫–æ–¥ my_commands
elif data == "set_topic_prompt":
    # –∫–æ–¥ set_topic_prompt
```

### 2. –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ callback query:
```python
# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–ª–∏—à–∫–æ–º –ª–∏ —Å—Ç–∞—Ä—ã–π –∑–∞–ø—Ä–æ—Å (–±–æ–ª–µ–µ 55 —Å–µ–∫)
current_time = time.time()
query_time = callback_query.message.date.timestamp()

if current_time - query_time > 55:
    await bot.answer_callback_query(callback_query.id, "‚ùå –ó–∞–ø—Ä–æ—Å —É—Å—Ç–∞—Ä–µ–ª, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞")
    return
```

### 3. –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π:
```python
try:
    await bot.answer_callback_query(callback_query.id)
except Exception as e:
    logger.warning(f"Failed to answer callback query: {str(e)}")
    # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ —Å–º–æ–≥–ª–∏ –æ—Ç–≤–µ—Ç–∏—Ç—å
```

### 4. –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å–ø–∞–º–∞ –æ—à–∏–±–æ–∫:
```python
# –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö "query too old"
if "Query is too old" not in str(e):
    await bot.send_message(chat_id=chat_id, text=f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ:

1. **–ë—ã—Å—Ç—Ä—ã–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–æ–∫** - –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—à–∏–±–æ–∫
2. **–ö–Ω–æ–ø–∫–∏ –≤ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫** - –≤—Å–µ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å  
3. **–¢–æ–ø–∏–∫-–Ω–∞—Å—Ç—Ä–æ–π–∫–∏** - —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
4. **–ê–¥–º–∏–Ω—Å–∫–∞—è –ø–∞–Ω–µ–ª—å** - –≤—Å–µ callback queries –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:

–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ª–æ–≥–∏ backend:
```bash
tail -f /var/log/supervisor/backend.err.log
```

–ï—Å–ª–∏ –æ—à–∏–±–∫–∏ "Query is too old" –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –Ω–µ—Ç –º–µ–¥–ª–µ–Ω–Ω—ã—Ö AI –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ callback handlers
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å MongoDB

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç:

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –æ—à–∏–±–∫–∏ "Query is too old" –¥–æ–ª–∂–Ω—ã –∏—Å—á–µ–∑–Ω—É—Ç—å.
–í—Å–µ callback queries —Ç–µ–ø–µ—Ä—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ –±—ã—Å—Ç—Ä–æ.